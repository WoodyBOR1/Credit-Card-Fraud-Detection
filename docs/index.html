<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>üõ°Ô∏è D√©tection Fraude CB - Version 2.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Versions verrouill√©es pour stabilit√© maximale -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.holoviz.org/panel/1.4.4/dist/panel.min.js"></script>

    <style>
        :root {
            --primary: #0072B5;
            --bg: #f8fafc;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background-color: var(--bg);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status {
            font-weight: bold;
            color: #333;
        }

        #version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.7em;
            color: #ccc;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Chargement du Syst√®me (v2.1)...</div>
    </div>

    <div id="content"></div>
    <div id="version">Build 2026.01.30.1930</div>

    <script type="text/javascript">
        async function main() {
            try {
                const status = document.getElementById('status');

                status.innerText = "üöÄ Initialisation Python...";
                let pyodide = await loadPyodide();

                status.innerText = "üì¶ Installation des librairies...";
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");

                // Installation sans fioritures
                await micropip.install([
                    'bokeh==3.4.1',
                    'panel==1.4.4',
                    'pandas',
                    'hvplot',
                    'holoviews'
                ]);

                status.innerText = "üì• Chargement des donn√©es...";
                const res = await fetch('creditcard_lite.csv?' + new Date().getTime()); // Force refresh
                if (!res.ok) throw new Error("Fichier CSV introuvable");
                const data = await res.arrayBuffer();
                pyodide.FS.writeFile('creditcard_lite.csv', new Uint8Array(data));

                status.innerText = "‚ú® Rendu du Dashboard...";
                await pyodide.runPythonAsync(`
import pandas as pd
import panel as pn
import hvplot.pandas
import holoviews as hv

# D√©sactivation des arguments risqu√©s
pn.extension(design='material', sizing_mode='stretch_width')

# Chargement
df = pd.read_csv('creditcard_lite.csv')

# M√©triques simples sans param√®tres d'alignement complexes
total = len(df)
frauds = len(df[df['Class'] == 1])
rate = (frauds / total) * 100 if total > 0 else 0

metric_cards = pn.Row(
    pn.indicators.Number(name="Transactions", value=total),
    pn.indicators.Number(name="Fraudes", value=frauds, colors=[(1, 'red')]),
    pn.indicators.Number(name="Taux (%)", value=rate, format='{value:.3f}%'),
    sizing_mode='stretch_width'
)

# Graphiques simples
h = df.hvplot.hist('Amount', bins=30, logy=True, height=350, alpha=0.7, title="Distribution Montants")
s = df.hvplot.scatter('V1', 'V2', c='Class', height=350, title="Clusters V1/V2")

# Assemblage ultra-safe
dashboard = pn.Column(
    pn.pane.Markdown("# üõ°Ô∏è Radar de Fraude Bancaire (v2.1)"),
    metric_cards,
    pn.Row(h, s, sizing_mode='stretch_width'),
    pn.pane.Markdown("### üîç √âchantillon de Transactions Suspectes"),
    pn.widgets.DataFrame(df[df['Class'] == 1].head(10), sizing_mode='stretch_width'),
    max_width=1100,
    align='center'
)

dashboard.servable(target='content')
                `);

                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                document.getElementById('status').innerHTML = "‚ùå <span style='color:red'>Erreur fatale</span><br><small>" + err.message + "</small>";
                console.error(err);
            }
        }
        main();
    </script>
</body>

</html>