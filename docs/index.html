<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>üõ°Ô∏è Dashboard D√©tection de Fraude</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Scripts stables (Panel 1.4.5 + Bokeh 3.4.1) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.holoviz.org/panel/1.4.5/dist/panel.min.js"></script>

    <style>
        :root {
            --primary: #0072B5;
            --bg: #f8fafc;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status {
            font-weight: 600;
            color: #1e293b;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Chargement du Syst√®me...</div>
    </div>

    <div id="content"></div>

    <script type="text/javascript">
        async function main() {
            try {
                let pyodide = await loadPyodide();
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");

                await micropip.install([
                    'bokeh==3.4.1',
                    'panel==1.4.5',
                    'pandas',
                    'hvplot',
                    'holoviews'
                ]);

                const csvRes = await fetch('creditcard_lite.csv');
                if (!csvRes.ok) throw new Error("Fichier CSV manquant !");
                const csvData = await csvRes.arrayBuffer();
                pyodide.FS.writeFile('creditcard_lite.csv', new Uint8Array(csvData));

                await pyodide.runPythonAsync(`
import pandas as pd
import panel as pn
import hvplot.pandas
import holoviews as hv

pn.extension(design='material', sizing_mode='stretch_width')

df = pd.read_csv('creditcard_lite.csv')

# Couleurs
FRAUD = "#D62728"
NORMAL = "#2CA02C"

# Metrics
total = len(df)
frauds = len(df[df['Class'] == 1])
rate = (frauds / total) * 100 if total > 0 else 0

metrics = pn.Row(
    pn.indicators.Number(name="Transactions", value=total, font_size='18pt'),
    pn.indicators.Number(name="Fraudes", value=frauds, font_size='18pt', colors=[(1, FRAUD)]),
    pn.indicators.Number(name="Taux (%)", value=rate, font_size='18pt', format='{value:.3f}%')
)

plots = pn.Row(
    df.hvplot.hist('Amount', bins=40, logy=True, height=350, color=NORMAL, title="Montants (Log)"),
    df.hvplot.scatter('V1', 'V2', c='Class', cmap=[NORMAL, FRAUD], title="V1 vs V2", height=350)
)

layout = pn.Column(
    pn.pane.Markdown("# üõ°Ô∏è D√©tection de Fraude"),
    metrics,
    plots,
    pn.pane.Markdown("### üìÑ √âchantillon Frauduleux"),
    pn.widgets.DataFrame(df[df['Class'] == 1].head(10), sizing_mode='stretch_width', height=300),
    max_width=1000, align='center'
)

layout.servable(target='content')
                `);

                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                document.getElementById('status').innerText = "‚ùå Erreur : " + err.message;
            }
        }
        main();
    </script>
</body>

</html>