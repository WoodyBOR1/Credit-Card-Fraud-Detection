<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>üõ°Ô∏è Dashboard D√©tection de Fraude</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Scripts CDN stables (Panel 1.4.5 + Bokeh 3.4.1) -->
    <!-- CETTE COMBINAISON EVITE L'ERREUR ClearInput -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.holoviz.org/panel/1.4.5/dist/panel.min.js"></script>

    <style>
        :root {
            --primary: #0072B5;
            --bg: #f8fafc;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border-top: 5px solid var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status {
            font-weight: 600;
            color: #1e293b;
            text-align: center;
        }

        #log {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 10px;
            font-family: monospace;
        }

        #content {
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Initialisation du Dashboard...</div>
        <div id="log">Pr√©paration de l'environnement Python...</div>
    </div>

    <div id="content"></div>

    <script type="text/javascript">
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');

        function setStatus(status, log = "") {
            statusEl.innerText = status;
            logEl.innerText = log;
        }

        async function main() {
            try {
                setStatus("üöÄ D√©marrage", "Chargement de Pyodide...");
                let pyodide = await loadPyodide();

                setStatus("üì¶ Installation", "Installation des librairies (Patientez...)");
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");

                // On force Bokeh 3.4.1 pour √©viter l'erreur ClearInput
                await micropip.install([
                    'bokeh==3.4.1',
                    'panel==1.4.5',
                    'pandas',
                    'hvplot',
                    'holoviews'
                ]);

                setStatus("üì• Donn√©es", "R√©cup√©ration du fichier creditcard_lite.csv...");
                const csvResponse = await fetch('creditcard_lite.csv');
                if (!csvResponse.ok) throw new Error("Fichier CSV manquant sur le serveur !");
                const csvData = await csvResponse.arrayBuffer();
                pyodide.FS.writeFile('creditcard_lite.csv', new Uint8Array(csvData));

                setStatus("üé® Rendu", "G√©n√©ration graphique en cours...");
                await pyodide.runPythonAsync(`
import pandas as pd
import panel as pn
import hvplot.pandas
import holoviews as hv

pn.extension(design='material', sizing_mode='stretch_width')

# Chargement
df = pd.read_csv('creditcard_lite.csv')

# --- Design ---
ACCENT = "#0072B5"
FRAUD = "#D62728"
NORMAL = "#2CA02C"

# --- Metrics ---
total = len(df)
frauds = len(df[df['Class'] == 1])
rate = (frauds / total) * 100 if total > 0 else 0

indicator_row = pn.Row(
    pn.indicators.Number(name="Total", value=total, font_size='22pt'),
    pn.indicators.Number(name="Fraudes", value=frauds, font_size='22pt', colors=[(1, FRAUD)]),
    pn.indicators.Number(name="Taux (%)", value=rate, font_size='22pt', format='{value:.3f}%'),
    justify_content='space-around', margin=(10, 0)
)

# --- Visualisations ---
amount_hist = df.hvplot.hist(
    'Amount', bins=40, logy=True, height=400, color=NORMAL, alpha=0.7,
    title="Analyse des Montants (Log Scale)"
)

scatter_v1_v2 = df.hvplot.scatter(
    x='V1', y='V2', c='Class', cmap=[NORMAL, FRAUD],
    title="Clusters G√©om√©triques V1/V2", height=400, alpha=0.5, size=40
)

var_select = pn.widgets.Select(name='Variable √† inspecter :', options=['V14', 'V17', 'V12', 'Amount'], value='V17')

@pn.depends(var_select)
def box_plot(var):
    return df.hvplot.box(y=var, by='Class', height=400, color=[NORMAL, FRAUD], title=f"Distributions compar√©es : {var}")

# --- Layout ---
layout = pn.Column(
    pn.pane.Markdown("# üõ°Ô∏è Surveillance des Fraudes Bancaires", styles={'color': ACCENT, 'font-size': '24pt'}),
    indicator_row,
    pn.Row(amount_hist, scatter_v1_v2),
    pn.Row(pn.Column("### Isolation des Variables", var_select, box_plot)),
    pn.pane.Markdown("### üìÑ √âchantillon des Transactions Frauduleuses"),
    pn.widgets.DataFrame(df[df['Class'] == 1].head(12), sizing_mode='stretch_width', height=300),
    max_width=1100, align='center', margin=(15, 15)
)

layout.servable(target='content')
                `);

                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                setStatus("‚ùå √âchec Critique", err.message);
                document.querySelector('.spinner').style.borderTopColor = 'red';
                console.error(err);
            }
        }
        main();
    </script>
</body>

</html>