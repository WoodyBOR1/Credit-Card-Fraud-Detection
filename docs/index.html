<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>üõ°Ô∏è Dashboard D√©tection de Fraude</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Scripts CDN les plus r√©cents et stables -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.27.2/full/pyodide.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.6.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.6.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.6.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.holoviz.org/panel/1.5.5/dist/panel.min.js"></script>

    <style>
        :root {
            --primary: #0072B5;
            --bg: #f8fafc;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status {
            font-weight: 600;
            color: #1e293b;
            text-align: center;
            max-width: 80%;
        }

        #log {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 10px;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Chargement du Dashboard...</div>
        <div id="log">Prise de contact avec Pyodide...</div>
    </div>

    <div id="content"></div>

    <script type="text/javascript">
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');

        function updateProgress(status, log = "") {
            statusEl.innerText = status;
            logEl.innerText = log;
            console.log(`[Dashboard] ${status} - ${log}`);
        }

        async function main() {
            try {
                updateProgress("üöÄ Initialisation", "Chargement de la machine virtuelle Python...");
                let pyodide = await loadPyodide();

                updateProgress("üì¶ Installation", "Chargement de Panel, Bokeh et Pandas...");
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");

                // Installation sans conflit de version
                await micropip.install([
                    'bokeh==3.6.1',
                    'panel==1.5.5',
                    'pandas',
                    'hvplot',
                    'holoviews',
                    'numpy'
                ]);

                updateProgress("üì• Donn√©es", "T√©l√©chargement de creditcard_lite.csv...");
                const csvResponse = await fetch('creditcard_lite.csv');
                if (!csvResponse.ok) throw new Error("Fichier de donn√©es introuvable.");
                const csvData = await csvResponse.arrayBuffer();
                pyodide.FS.writeFile('creditcard_lite.csv', new Uint8Array(csvData));

                updateProgress("üé® Rendu", "Construction de l'interface graphique...");
                await pyodide.runPythonAsync(`
import pandas as pd
import panel as pn
import hvplot.pandas
import holoviews as hv

pn.extension(design='material', sizing_mode='stretch_width')

# Chargement
df = pd.read_csv('creditcard_lite.csv')

# --- Design ---
ACCENT = "#0072B5"
FRAUD = "#D62728"
NORMAL = "#2CA02C"

# --- Calculs ---
total = len(df)
frauds = len(df[df['Class'] == 1])
rate = (frauds / total) * 100 if total > 0 else 0

# --- Composants ---
metrics = pn.Row(
    pn.indicators.Number(name="Total", value=total, font_size='20pt'),
    pn.indicators.Number(name="Fraudes", value=frauds, font_size='20pt', colors=[(1, FRAUD)]),
    pn.indicators.Number(name="Taux %", value=rate, font_size='20pt', format='{value:.3f}%'),
    justify_content='space-around', margin=(10, 0)
)

amount_p = df.hvplot.hist('Amount', bins=40, logy=True, height=350, color=NORMAL, alpha=0.7, title="Montants (Log)")
scatter_p = df.hvplot.scatter(x='V1', y='V2', c='Class', cmap=[NORMAL, FRAUD], title="V1 vs V2", height=350, alpha=0.5)

var_select = pn.widgets.Select(name='Variable :', options=['V14', 'V17', 'V12', 'Amount'], value='V17')

@pn.depends(var_select)
def box_view(var):
    return df.hvplot.box(y=var, by='Class', height=350, color=[NORMAL, FRAUD], title=f"Distrib {var}")

# Layout
layout = pn.Column(
    pn.pane.Markdown("# üõ°Ô∏è Surveillance Fraude Bancaire", styles={'color': ACCENT, 'font-size': '24pt'}),
    metrics,
    pn.Row(amount_p, scatter_p),
    pn.Row(pn.Column(var_select, box_view)),
    pn.pane.Markdown("### üîç Transactions Frauduleuses (Echantillon)"),
    pn.widgets.DataFrame(df[df['Class'] == 1].head(10), sizing_mode='stretch_width', height=300),
    max_width=1000, align='center', margin=(20, 20)
)

layout.servable(target='content')
                `);

                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                updateProgress("‚ùå √âchec Critique", err.message);
                document.querySelector('.spinner').style.borderTopColor = 'red';
                console.error(err);
            }
        }
        main();
    </script>
</body>

</html>