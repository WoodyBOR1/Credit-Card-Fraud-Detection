<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Dashboard D√©tection de Fraude</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.3.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.3.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.3.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.holoviz.org/panel/1.3.1/dist/panel.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: roboto, sans-serif; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading">üöÄ Chargement du Dashboard (Pyodide)... Merci de patienter quelques secondes.</div>
    <div id="content"></div>

    <script type="text/javascript">
        async function main() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            await micropip.install(['pandas', 'hvplot', 'holoviews', 'panel']);
            
            await pyodide.runPythonAsync(`
import pandas as pd
import panel as pn
import hvplot.pandas
import holoviews as hv

pn.extension(design='material')

DATA_URL = 'creditcard_lite.csv'

def load_data():
    try:
        df = pd.read_csv(DATA_URL)
        return df
    except Exception as e:
        return pd.DataFrame({'Error': [str(e)]})

df = load_data()

# Styles
ACCENT_COLOR = "#0072B5"
FRAUD_COLOR = "#D62728"
NORMAL_COLOR = "#2CA02C"

# Components
total = len(df)
frauds = len(df[df['Class'] == 1])
rate = (frauds / total) * 100 if total > 0 else 0

metrics = pn.Row(
    pn.indicators.Number(name="Transactions Totales", value=total, font_size='22pt'),
    pn.indicators.Number(name="Frauduleuses", value=frauds, font_size='22pt', colors=[(1, FRAUD_COLOR)]),
    pn.indicators.Number(name="Taux %", value=rate, font_size='22pt', format='{value:.3f}%'),
    sizing_mode='stretch_width', justify_content='space-around'
)

amount_plot = df.hvplot.hist(
    'Amount', bins=50, logy=True, title="Distribution des Montants (Log)",
    color=NORMAL_COLOR, height=350, responsive=True
)

scatter_plot = df.hvplot.scatter(
    x='V1', y='V2', c='Class', cmap=[NORMAL_COLOR, FRAUD_COLOR],
    title="Analyse V1 / V2", height=350, responsive=True
)

var_select = pn.widgets.Select(name='Variable pour Analyse', options=['Amount', 'V1', 'V2', 'V17', 'V14'], value='V17')

@pn.depends(var_select)
def get_box(var):
    return df.hvplot.box(y=var, by='Class', title=f"Profil {var}", height=350, responsive=True, color=[NORMAL_COLOR, FRAUD_COLOR])

main_content = pn.Column(
    pn.pane.Markdown("# üõ°Ô∏è Surveillance des Fraudes Bancaires"),
    metrics,
    pn.Row(amount_plot, scatter_plot),
    pn.Row(var_select, get_box),
    pn.pane.Markdown("### üîç Aper√ßu des Fraudes"),
    pn.widgets.DataFrame(df[df['Class'] == 1].head(10), sizing_mode='stretch_width')
)

main_content.servable(target='content')
            `);
            document.getElementById('loading').style.display = 'none';
        }
        main();
    </script>
</body>
</html>